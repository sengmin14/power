name: Deploy To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSHÎ°ú EC2Ïóê Ï†ëÏÜçÌïòÏó¨ Î∞∞Ìè¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e

            echo "üì¶ Move to project directory"
            cd /home/ubuntu/power

            echo "üì• Pull latest code"
            git pull origin main

            echo "üìÇ Move to FE directory"
            cd /home/ubuntu/power/FE

            echo "üõë Kill existing Vite server (5173)"
            sudo fuser -k -n tcp 5173 || true

            echo "üöÄ Start Vite dev server"
            nohup npm run dev > vite.log 2>&1 &

            echo "‚è≥ Waiting for Vite server to be ready (5173)..."
            for i in {1..60}; do
              if lsof -i :5173 >/dev/null; then
                echo "‚úÖ Vite server is up"
                exit 0
              fi
              sleep 1
            done

            echo "‚ùå Vite server did not start within 60 seconds"
            exit 1