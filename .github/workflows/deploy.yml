name: Deploy To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSHÎ°ú EC2Ïóê Ï†ëÏÜçÌïòÏó¨ Î∞∞Ìè¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e

            echo "üì¶ Move to project directory"
            cd /home/ubuntu/power

            echo "üì• Pull latest code"
            git pull origin main

            echo "üìÇ Move to FE directory"
            cd /home/ubuntu/power/FE

            echo "npm install Ï∂îÍ∞Ä by rhinod"
            npm install
            
            
            echo "üöÄ Start Vite dev server"
            screen -dmS "react-server" npm run dev

            echo "‚è≥ Waiting for Vite server to be ready (5173)..."
            for i in {1..40}; do
              if ss -lntp | grep ':5173' >/dev/null; then

                echo "‚úÖ Vite server is up"
                exit 0
              fi
              sleep 1
            done

            echo "‚ùå Vite server did not start within 40 seconds"
            exit 1